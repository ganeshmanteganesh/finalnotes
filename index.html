<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸ“‚ Supabase Folder Viewer (Headers & Search)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
Â  font-family: 'Inter', sans-serif;
Â  margin: 0;
Â  background: #f1f5f9;
Â  display: flex;
Â  flex-direction: column;
Â  height: 100vh;
Â  overflow: hidden;
}

#left {
Â  z-index: 50;
Â  background: #fff;
Â  overflow-y: auto;
Â  box-sizing: border-box;
Â  transition: transform .3s;
Â  box-shadow: 2px 0 10px rgba(0,0,0,.1);
Â  position: fixed;
Â  top: 0;
Â  left: 0;
Â  width: 100%;
Â  max-width: 350px;
Â  height: 100%;
Â  transform: translateX(-100%);
Â  padding: 1rem;
}

#left.open {
Â  transform: translateX(0);
}

#right {
  flex: 1;
  padding: 0.5rem;
  box-sizing: border-box;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}
#text_viewer {
  flex: 1;
  background: transparent !important; /* Removes white box */
  padding: 1.5rem;
  line-height: 1.8;
  font-size: 1rem;
  color: #000;
  font-weight: 500;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: break-word;
  max-width: 100%;
  margin: 0;
  overflow-y: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
  box-shadow: none !important;
  border: none !important;
  border-radius: 0 !important;
   color: #000;         /* black text */
  font-weight: bold;   /* bold text */
}
#text_viewer::-webkit-scrollbar {
  display: none;
}


.highlight {
Â  background: #fcd34d;
Â  transition: background .5s;
}

select, input, button:not(#prev_topic_btn):not(#next_topic_btn) {
Â  width: 100%;
Â  margin-bottom: .75rem;
Â  padding: 1rem;
Â  border-radius: .5rem;
Â  border: 1px solid #cbd5e1;
}

button {
Â  background: #4f46e5;
Â  color: #fff;
Â  font-weight: 600;
Â  transition: background .15s;
}

button:hover:not(:disabled) {
Â  background: #4338ca;
}

button:disabled {
Â  background: #9ca3af;
Â  cursor: not-allowed;
}

ul {
Â  list-style: none;
Â  padding: 0;
Â  max-height: 400px;
Â  overflow-y: auto;
Â  border: 1px solid #cbd5e1;
Â  border-radius: .5rem;
}

li {
Â  padding: .75rem 1rem;
Â  cursor: pointer;
Â  transition: background .1s;
Â  border-bottom: 1px solid #f1f5f9;
}

li:last-child {
Â  border-bottom: none;
}

li:hover {
Â  background: #eff6ff;
Â  color: #1e40af;
}

.small {
Â  font-size: .85rem;
Â  color: #475569;
}

.file-list {
Â  max-height: 260px;
Â  overflow: auto;
Â  border: 1px solid #e6edf3;
Â  border-radius: 8px;
Â  background: #fff;
}

@media(min-width:640px) {
Â  body {
Â  Â  flex-direction: row;
Â  }
Â  #left {
Â  Â  position: static;
Â  Â  width: 200px;
Â  Â  max-width: none;
Â  Â  height: 100%;
Â  Â  transform: translateX(0);
Â  Â  border-right: 2px solid #e2e8f0;
Â  }
Â  #menu_toggle_btn {
Â  Â  display: none;
Â  }
} </style>

</head>
<body>

<!-- Left panel -->
<div id="left">
Â  <div class="flex justify-between items-center mb-4 border-b pb-4">
Â  Â  <h3 class="text-xl font-bold text-gray-800">ğŸ“‹ Navigator (Supabase)</h3>
Â  Â  <button id="close_menu_btn" class="sm:hidden text-gray-500 p-1 rounded-full bg-gray-100">âœ•</button>
Â  </div>

Â  <h4 class="text-sm font-semibold mb-2 text-gray-700">Storage Management</h4>
Â  <label class="block text-xs font-medium text-gray-700">ğŸ“ Folder:</label>
Â  <select id="folder_dropdown" class="mb-4 text-sm"></select>

Â  <input type="text" id="new_folder_name" placeholder="New folder name" class="mb-2 text-sm"/>
Â  <button id="add_folder_btn" class="mb-6 text-sm">â• Add Folder</button>

Â  <label class="block text-xs font-medium text-gray-700">ğŸ“„ Upload Folder (.txt only):</label>
Â  <input type="file" id="folder_input" webkitdirectory directory multiple class="mb-6" />

Â  <h4 class="text-sm font-semibold mb-2 text-gray-700 border-t pt-4">Search & Topics</h4>
Â  <label class="block text-xs font-medium text-gray-700">ğŸ” Search:</label>
Â  <input type="text" id="search_box" placeholder="Search headers..." class="mb-4 text-sm" />

Â  <label class="block text-xs font-medium text-gray-700">ğŸ“„ Current Topic:</label>
Â  <select id="topic_dropdown" class="mb-6 text-sm"></select>

Â  <label class="block text-xs font-medium text-gray-700">ğŸ§­ Headings/Subheadings:</label>
Â  <ul id="subheading_list" class="bg-gray-50 shadow-inner text-sm"></ul>
</div>

<!-- Right panel -->
<div id="right">
Â  <button id="menu_toggle_btn" class="sm:hidden fixed top-4 left-4 z-40 p-3 bg-indigo-600 text-white rounded-full shadow-lg">â˜°</button>

Â <div id="text_viewer" class="text-gray-800 text-base">
  <h1 class="text-2xl font-bold mb-4 text-indigo-700">Welcome</h1>
  <p class="mb-3">Upload a folder containing many <code>.txt</code> files. Files will be saved to Supabase and displayed here.</p>
</div>

<div id="navigation_controls" class="flex justify-center space-x-4 py-4 sm:pt-4">
  <button id="prev_topic_btn" class="flex-1 max-w-xs py-3 rounded-xl text-lg disabled:opacity-50">&larr; Prev</button>
  <button id="next_topic_btn" class="flex-1 max-w-xs py-3 rounded-xl text-lg disabled:opacity-50">Next &rarr;</button>
</div>

Â  <div style="padding:12px;">
Â  Â  <div class="small mb-2">Selected folder files (client-side preview)</div>
Â  Â  <div id="selected_files" class="file-list p-2 mb-3 small"></div>
Â  Â  <div class="flex gap-2">
Â  Â  Â  <button id="upload_all_btn" class="btn">ğŸ“¤ Upload Folder(s) to Supabase</button>
Â  Â  Â  <button id="clear_selection_btn" class="btn" style="background:#64748b">Clear</button>
Â  Â  Â  <button id="refresh_btn" class="btn" style="background:#0ea5a4">Refresh Folders</button>
Â  Â  </div>
Â  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://xxubhwmczpgxqflvcwzd.supabase.co";
Â  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4dWJod21jenBneHFmbHZjd3pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjI5MjUsImV4cCI6MjA2OTQ5ODkyNX0.nAWluTg9q57gb7XFTlkvhZHxTbK0rx2O2wdmEAt_F7Q";
Â  // ------------------------------------------------------------------
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// DOM elements
const folderDropdown = document.getElementById("folder_dropdown");
const topicDropdown = document.getElementById("topic_dropdown");
const subheadingList = document.getElementById("subheading_list");
const textViewer = document.getElementById("text_viewer");
const folderInput = document.getElementById("folder_input");
const searchBox = document.getElementById("search_box");
const addFolderBtn = document.getElementById("add_folder_btn");
const newFolderInput = document.getElementById("new_folder_name");
const uploadAllBtn = document.getElementById("upload_all_btn");
const selectedFilesDiv = document.getElementById("selected_files");
const clearSelBtn = document.getElementById("clear_selection_btn");
const refreshBtn = document.getElementById("refresh_btn");
const prevTopicBtn = document.getElementById("prev_topic_btn");
const nextTopicBtn = document.getElementById("next_topic_btn");
const leftPanel = document.getElementById("left");
const menuToggleBtn = document.getElementById("menu_toggle_btn");
const closeMenuBtn = document.getElementById("close_menu_btn");

let currentFolder = null;
let currentTopics = [];
let currentSections = [];
let currentFileContent = "";
let currentFileIndex = -1;
let selectedFiles = [];

// Read file as text
function readFileAsText(file){
Â  Â  return new Promise((res, rej)=>{
Â  Â  Â  Â  const r = new FileReader();
Â  Â  Â  Â  r.onload = e => res(e.target.result);
Â  Â  Â  Â  r.onerror = e => rej(e);
Â  Â  Â  Â  r.readAsText(file);
Â  Â  });
}

// Show selected files
function showSelectedFiles(files){
Â  Â  selectedFilesDiv.innerHTML = '';
Â  Â  if (!files || files.length === 0){
Â  Â  Â  Â  selectedFilesDiv.innerHTML = '<div class="p-2 small text-gray-500">No files selected</div>';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  files.forEach((f, idx)=>{
Â  Â  Â  Â  const d = document.createElement('div');
Â  Â  Â  Â  d.className = 'p-2 border-b small';
Â  Â  Â  Â  d.textContent = `page_${idx+1}`;
Â  Â  Â  Â  selectedFilesDiv.appendChild(d);
Â  Â  });
}

// Convert files for Supabase
async function convertFilesToObjects(fileArray){
Â  Â  const out = [];
Â  Â  for(let i=0;i<fileArray.length;i++){
Â  Â  Â  Â  const f = fileArray[i];
Â  Â  Â  Â  const content = await readFileAsText(f);
Â  Â  Â  Â  out.push({ name: `page_${i+1}.txt`, content });
Â  Â  }
Â  Â  return out;
}

async function uploadFolderToSupabase(folderName, fileObjs){
Â  Â  try{
Â  Â  Â  Â  const filesAsJson = await convertFilesToObjects(fileObjs);
Â  Â  Â  Â  const { data: existing } = await supabase.from('folders').select('*').eq('name', folderName).maybeSingle();

Â  Â  Â  Â  if(existing && Array.isArray(existing.files)){
Â  Â  Â  Â  Â  Â  const map = new Map();
Â  Â  Â  Â  Â  Â  for(const it of existing.files) map.set(it.filename||it.name, it.content);
Â  Â  Â  Â  Â  Â  for(const it of filesAsJson) map.set(it.name, it.content);
Â  Â  Â  Â  Â  Â  const merged = Array.from(map.entries()).map(([filename, content])=>({ filename, content }));
Â  Â  Â  Â  Â  Â  await supabase.from('folders').update({ files: merged }).eq('name', folderName);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const payload = filesAsJson.map(f=>({ filename: f.name, content: f.content }));
Â  Â  Â  Â  Â  Â  await supabase.from('folders').insert([{ name: folderName, files: payload }]);
Â  Â  Â  Â  }
Â  Â  }catch(err){
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  // Using a message box instead of alert()
Â  Â  Â  Â  document.getElementById('text_viewer').textContent = 'Upload failed: '+(err.message||JSON.stringify(err));
Â  Â  }
}

// Handle file input
folderInput.addEventListener('change', e=>{
Â  Â  const files = Array.from(e.target.files||[]);
Â  Â  selectedFiles = files.filter(f=>f.name.toLowerCase().endsWith('.txt'));
Â  Â  showSelectedFiles(selectedFiles);
});

// Upload all
uploadAllBtn.addEventListener('click', async ()=>{
Â  Â  if(!selectedFiles || selectedFiles.length===0){ 
Â  Â  Â  Â  // Using a message box instead of alert()
Â  Â  Â  Â  document.getElementById('text_viewer').textContent = 'Select folder/files first';
Â  Â  Â  Â  return; 
Â  Â  }
Â  Â  uploadAllBtn.disabled = true;
Â  Â  uploadAllBtn.textContent = 'Uploading...';
Â  Â  const groups = groupByTopLevel(selectedFiles);
Â  Â  for(const [folderName, files] of Object.entries(groups)){
Â  Â  Â  Â  await uploadFolderToSupabase(folderName, files);
Â  Â  }
Â  Â  uploadAllBtn.textContent = 'Upload Folder(s) to Supabase';
Â  Â  uploadAllBtn.disabled = false;
Â  Â  await loadFolders();
Â  Â  document.getElementById('text_viewer').innerHTML = '<h1 class="text-2xl font-bold mb-4 text-green-600">Upload Complete!</h1><p class="mb-3">Your files are now stored in Supabase.</p>';
});

// Clear selection
clearSelBtn.addEventListener('click', ()=>{
Â  Â  selectedFiles = [];
Â  Â  folderInput.value = null;
Â  Â  showSelectedFiles([]);
});

// Add new folder
addFolderBtn.addEventListener('click', async ()=>{
Â  Â  const name = (newFolderInput.value||'').trim();
Â  Â  if(!name){ 
Â  Â  Â  Â  // Using a message box instead of alert()
Â  Â  Â  Â  document.getElementById('text_viewer').textContent = 'Enter folder name'; 
Â  Â  Â  Â  return; 
Â  Â  }
Â  Â  await supabase.from('folders').insert([{ name }]);
Â  Â  newFolderInput.value='';
Â  Â  await loadFolders();
});

// Group files by top-level folder
function groupByTopLevel(files){
Â  Â  const groups = {};
Â  Â  for(const f of files){
Â  Â  Â  Â  const rel = f.webkitRelativePath||f.name;
Â  Â  Â  Â  const parts = rel.split('/');
Â  Â  Â  Â  const top = parts.length>1?parts[0]:'Uploaded_'+new Date().toISOString().replace(/[:.]/g,'-');
Â  Â  Â  Â  if(!groups[top]) groups[top]=[];
Â  Â  Â  Â  groups[top].push(f);
Â  Â  }
Â  Â  return groups;
}

// Load all folders
async function loadFolders(){
Â  Â  const { data } = await supabase.from('folders').select('*').order('created_at',{ascending:true});
Â  Â  folderDropdown.innerHTML='';
Â  Â  if(!data || data.length===0){
Â  Â  Â  Â  folderDropdown.innerHTML='<option value="-1">No folders</option>';
Â  Â  Â  Â  topicDropdown.innerHTML='';
Â  Â  Â  Â  textViewer.innerHTML='<h2 class="text-lg font-semibold">No content</h2><p class="small">Upload a folder to get started.</p>';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  data.forEach(d=>{
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.value = d.name;
Â  Â  Â  Â  opt.textContent = `${d.name} (${Array.isArray(d.files)?d.files.length:0} files)`;
Â  Â  Â  Â  folderDropdown.appendChild(opt);
Â  Â  });
Â  Â  const last = localStorage.getItem('lastSelectedFolder');
Â  Â  const toSelect = last && Array.from(folderDropdown.options).some(o=>o.value===last)? last: folderDropdown.options[0].value;
Â  Â  folderDropdown.value = toSelect;
Â  Â  await selectFolder(toSelect);
}

// Select a folder
async function selectFolder(name){
Â  Â  if(!name) return;
Â  Â  currentFolder = name;
Â  Â  localStorage.setItem('lastSelectedFolder', name);
Â  Â  const { data } = await supabase.from('folders').select('*').eq('name', name).maybeSingle();
Â  Â  const raw = data && data.files? data.files : [];
Â  Â  currentTopics = raw.map((it,i)=>({
Â  Â  Â  Â  name: `page_${i+1}.txt`,
Â  Â  Â  Â  content: it.content || '',
Â  Â  Â  Â  mainHeading: extractMainHeading(it.content||'', it.filename||it.name)
Â  Â  }));
Â  Â  showSelectedFiles(raw);

Â  Â  topicDropdown.innerHTML='';
Â  Â  if(currentTopics.length===0){
Â  Â  Â  Â  topicDropdown.innerHTML='<option value="-1">No files uploaded</option>';
Â  Â  Â  Â  textViewer.innerHTML=`<h1 class="text-2xl font-bold mb-4 text-gray-700">No Content</h1><p class="text-gray-600">No files in folder: <b>${currentFolder}</b>.</p>`;
Â  Â  Â  Â  subheadingList.innerHTML='<li class="text-gray-500 italic p-3 text-xs">No extractable sections.</li>';
Â  Â  Â  Â  currentSections=[];
Â  Â  Â  Â  currentFileIndex=-1;
Â  Â  Â  Â  updateNavigationButtons();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  currentTopics.forEach((t,i)=>{
Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  option.value=i;
Â  Â  Â  Â  option.textContent=t.mainHeading||t.name;
Â  Â  Â  Â  topicDropdown.appendChild(option);
Â  Â  });
Â  Â  showFileContent(0);
}

// Extract main heading
function extractMainHeading(content, fallbackName) {
Â  Â  // Regex to find #### Heading #### (group 1) or **Heading** (group 2)
Â  Â  // Removed 'g' flag to ensure only the first match is returned
Â  Â  const regex = /####\s*(.+?)\s*####|\*\*\s*([^*:]+(?::[^*]+)?)\s*\*\*/;
Â  Â  const h = regex.exec(content);
Â  Â  if (h) {
Â  Â  Â  Â  // Return group 1 (####) or group 2 (**)
Â  Â  Â  Â  return (h[1] || h[2]).trim();
Â  Â  }
Â  Â  return fallbackName.replace(/\.txt$/i, '');
}


// Extract subheadings
function extractHeadingsAndSubheadings(content){
Â  Â const regex = /\*\*\s*([^*]*?:[^*]*?)\s*\*\*/gm;



Â  Â  const matches=[];
Â  Â  let m;
Â  Â  while((m=regex.exec(content))!==null) matches.push(m[1].trim());
Â  Â  return matches;
}

// Show file content
function showFileContent(idx){
Â  Â  if(idx<0 || idx>=currentTopics.length) return;
Â  Â  currentFileIndex=idx;
Â  Â  currentFileContent=currentTopics[idx].content;
Â  Â  textViewer.innerHTML = `<pre>${currentFileContent}</pre>`;
Â  Â  const headings = extractHeadingsAndSubheadings(currentFileContent);
Â  Â  currentSections=headings;
Â  Â  subheadingList.innerHTML='';
Â  Â  if(headings.length===0){
Â  Â  Â  Â  subheadingList.innerHTML='<li class="text-gray-500 italic p-3 text-xs">No headings found</li>';
Â  Â  } else {
Â  Â  Â  Â  headings.forEach(h=>{
Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  li.textContent=h;
Â  Â  Â  Â  Â  Â  li.onclick=()=>{highlightHeading(h);}
Â  Â  Â  Â  Â  Â  subheadingList.appendChild(li);
Â  Â  Â  Â  });
Â  Â  }
Â  Â  topicDropdown.value=idx;
Â  Â  updateNavigationButtons();
}

function highlightHeading(heading) {
Â  if (!heading) return;

Â  const container = document.getElementById("text_viewer_container");
Â  const textViewer = document.getElementById("text_viewer");

Â  // Enter fullscreen
Â  container.classList.add("fullscreen");

Â  // Create close button if not exists
Â  if (!document.getElementById("close_fullscreen")) {
Â  Â  const btn = document.createElement("button");
Â  Â  btn.id = "close_fullscreen";
Â  Â  btn.innerText = "Ã— Close";
Â  Â  btn.style.cssText = `
Â  Â  Â  position: absolute;
Â  Â  Â  top: 15px;
Â  Â  Â  right: 20px;
Â  Â  Â  background: #ef4444;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  padding: 8px 14px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 16px;
Â  Â  Â  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
Â  Â  Â  z-index: 200;
Â  Â  `;
Â  Â  btn.onclick = () => {
Â  Â  Â  container.classList.remove("fullscreen");
Â  Â  Â  btn.remove();
Â  Â  };
Â  Â  container.appendChild(btn);
Â  }

Â  // Highlight the heading and scroll to it
Â  const markerId = "scroll_marker_" + Math.random().toString(36).substr(2, 9);
Â  const regex = new RegExp(heading, "i");
Â  const highlighted = currentFileContent.replace(regex, `<span id="${markerId}" class="highlight">${heading}</span>`);
Â  textViewer.innerHTML = `<pre>${highlighted}</pre>`;

Â  const marker = document.getElementById(markerId);
Â  if (marker) marker.scrollIntoView({ behavior: "smooth", block: "center" });
}

// Navigation buttons
function updateNavigationButtons(){
Â  Â  prevTopicBtn.disabled = currentFileIndex<=0;
Â  Â  nextTopicBtn.disabled = currentFileIndex>=currentTopics.length-1;
}

topicDropdown.addEventListener('change', e=>{
Â  Â  const idx = parseInt(e.target.value);
Â  Â  if(!isNaN(idx)) showFileContent(idx);
});

prevTopicBtn.addEventListener('click', ()=>{ showFileContent(currentFileIndex-1); });
nextTopicBtn.addEventListener('click', ()=>{ showFileContent(currentFileIndex+1); });

folderDropdown.addEventListener('change', e=>{
Â  Â  selectFolder(e.target.value);
});

menuToggleBtn.addEventListener('click', ()=> leftPanel.classList.toggle('open'));
closeMenuBtn.addEventListener('click', ()=> leftPanel.classList.remove('open'));
refreshBtn.addEventListener('click', ()=> loadFolders());

// ğŸ” Search headers only
searchBox.addEventListener('input', e => {
Â  Â  const val = e.target.value.toLowerCase();
Â  Â  Array.from(topicDropdown.options).forEach(opt => {
Â  Â  Â  Â  if (opt.value == "-1") return;
Â  Â  Â  Â  const t = currentTopics[parseInt(opt.value)];
Â  Â  Â  Â  opt.hidden = !(t.mainHeading && t.mainHeading.toLowerCase().includes(val));
Â  Â  });
Â  Â  const firstVisible = Array.from(topicDropdown.options).find(o => !o.hidden && o.value != "-1");
Â  Â  if (firstVisible) {
Â  Â  Â  Â  topicDropdown.value = firstVisible.value;
Â  Â  Â  Â  showFileContent(parseInt(firstVisible.value));
Â  Â  }
});

// Initialize
loadFolders();
</script>
</body>
</html>
